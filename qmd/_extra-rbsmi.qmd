---
execute:
  eval: false
---

# RBSMI – Preliminary Results

## Setting the Environment

```{r}
library(askpass)
library(car)
library(checkmate)
library(dplyr)
library(ggplot2)
library(googlesheets4)
library(grDevices)
library(here)
library(hms)
library(lubridate)
library(lubritime) # github.com/danielvartan/lubritime
library(plotr) # github.com/danielvartan/plotr
library(rutils) # github.com/danielvartan/rutils
library(scaler) # github.com/danielvartan/scaler
library(sodium)
library(stats)
library(stringr)
library(summarytools)
library(tidyr)
```

```{r}
anonymize_id <- function(x, salt) {
  checkmate::assert_atomic(x)
  checkmate::assert_character(as.character(x), pattern = "^\\d{11}$")
  checkmate::assert_string(salt)

  vapply(
    X = x,
    FUN = function(x, salt) {
      as.character(x) |>
        charToRaw() |>
        sodium::scrypt(salt = charToRaw(salt), size = 32) |>
        sodium::bin2hex() |>
        stringr::str_trunc(8, ellipsis = "")
    },
    FUN.VALUE = character(1),
    salt = salt,
    USE.NAMES = FALSE
  )
}
```

## Setting Keys

```{r}
salt <- askpass::askpass()
```

## Downloading the Data

```{r}
#| output: false

googlesheets4::gs4_auth()
```

The following are internal data collected and organized using a Google Form to facilitate the management of the study.

```{r}
#| output: false

control_form <- googlesheets4::read_sheet(
  ss = "13wtDr4fRD1wJSM-qdLOdGSchF8oXU1bG0Jtccu24GhY",
  sheet = "Dataset",
  col_types = "c"
)
```

The following are data extracted from the Google Form used to collect data from the participants of the study.

```{r}
#| output: false

field_form <- googlesheets4::read_sheet(
  ss = "1tY_TT0nPXFsErYQS2VED0-hqTzgHudA9BfhRhYG19fw",
  sheet = "Dataset",
  col_types = "c"
)
```

The sleep data were extracted using the Condor Instrument [ActStudio](https://condorinst.com/en/actstudio-software/) software and subsequently formatted in Google Sheets for further analysis.

```{r}
#| output: false

sleep_input <- googlesheets4::read_sheet(
  ss = "1iqjhdSiWYr9RYSvIvJQfFw35DR31YA_oj2SW8iR5WPw",
  sheet = "Dataset",
  col_types = "c"
)
```

Medical records were obtained from participants' medical files and organized in Google Sheets for subsequent analysis.

```{r}
#| output: false

medical_record_input <- googlesheets4::read_sheet(
  ss = "10yvvTOCjZsRKPO8A4yn0NCvWe4Jn_Kq-Zu_CV4miGJI",
  sheet = "Dataset",
  col_types = "c"
)
```

## Data Munging

```{r}
control_data <-
  control_form |>
  `names<-`(paste0("X", seq_along(control_form))) |>
  dplyr::select(X5, X6, X7, X12, X13, X14) |>
  dplyr::rename(
    cpf = X5,
    id = X6,
    name = X7,
    birth_center_delivery = X12,
    birth = X13,
    labor_start = X14
  ) |>
  dplyr::mutate(
    birth_center_delivery = dplyr::case_when(
      tolower(trimws(birth_center_delivery)) == "sim" ~ TRUE,
      tolower(trimws(birth_center_delivery)) == "não" ~ FALSE,
      TRUE ~ NA
    ),
    birth = lubridate::as_datetime(birth),
    labor_start = lubridate::as_datetime(labor_start)
  ) |>
  dplyr::mutate(
    labor_duration =
      lubridate::interval(
        start = labor_start,
        end = birth
      ) |>
        lubritime::int_duration()
  ) |>
  dplyr::filter(!is.na(labor_duration)) |>
  dplyr::select(id, birth_center_delivery, labor_start, labor_duration)

control_data
```

```{r}
field_form_data <-
  field_form |>
  `names<-`(paste0("X", seq_along(field_form))) |>
  dplyr::select(
    X1, X4, X5, X11, X91, X92, X95, X96, X97, X99, X101, X102, X106, X119,
    X118, X125, X126
  ) |>
  dplyr::rename(
    timestamp = X1,
    birth_date = X4,
    cpf = X5,
    weight_before = X96,
    weight_current = X95,
    height = X97,
    ethnicity = X106,
    education = X118,
    family_income = X99,
    health_plan = X101,
    solo = X102,
    exercise = X119,
    work = X92,
    study = X91,
    gestations = X11,
    deliveries = X125,
    abortions = X126
  ) |>
  dplyr::mutate(
    id = anonymize_id(cpf, salt),
    timestamp = lubridate::mdy_hms(timestamp),
    birth_date = lubridate::dmy(birth_date),
    age = scaler:::age(birth_date, timestamp),
    ethnicity = factor(
      ethnicity,
      levels = c(
        "Indígena",
        "Preta",
        "Parda",
        "Amarela",
        "Branca"
      ),
      ordered = TRUE
    ),
    education = factor(
      education,
      levels = c(
        "Não frequentou a escola",
        "Fundamental incompleto",
        "Fundamental completo",
        "Ensino médio incompleto",
        "Ensino médio completo",
        "Ensino superior incompleto",
        "Ensino superior completo",
        "Mestrado incompleto",
        "Mestrado completo",
        "Doutorado incompleto",
        "Doutorado completo",
        "Pós-doutorado incompleto",
        "Pós-doutorado completo"
      ),
      ordered = TRUE
    ),
    gestations = dplyr::case_match(
      gestations,
      c("Sim", "0") ~ "1",
      "Não" ~ "0",
      .default = gestations
    ),
    deliveries = dplyr::case_when(
      is.na(deliveries) ~ "0",
      TRUE ~ deliveries
    ),
    abortions = dplyr::case_when(
      is.na(abortions) ~ "0",
      TRUE ~ abortions
    )
  ) |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::all_of(
        c(
          "weight_before", "weight_current", "height",
          "family_income", "gestations", "deliveries",
          "abortions"
        )
      ),
      .fns = as.numeric
    )
  ) |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::all_of(
        c("health_plan", "solo", "exercise", "work", "study")
      ),
      .fns = function(x) {
        dplyr::case_match(
          x,
          "Sim" ~ TRUE,
          "Não" ~ FALSE
        )
      }
    )
  ) |>
  dplyr::mutate(
    gestations = dplyr::case_when(
      id == "ae5fc5cd" ~ 3,
      TRUE ~ gestations
    ),
  ) |>
  dplyr::mutate(
    bmi_before = weight_before / ((height / 100)^2),
    bmi_current = weight_current / ((height / 100)^2)
  ) |>
  dplyr::select(-cpf) |>
  dplyr::relocate(
    id, timestamp, birth_date, age, weight_before, weight_current, height, bmi_before, bmi_current, family_income
  )

field_form_data
```

```{r}
sleep_data <-
  sleep_input |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::matches("^his_|^hfs_|^fps_|^tts_m|^tts_sd|^waso_"),
      .fns = hms::parse_hms
    ),
    dplyr::across(
      .cols = dplyr::matches("^tts_fps_|^awakenings_"),
      .fns = as.numeric
    )
  )

sleep_data
```

```{r}
medical_record_data <-
  medical_record_input |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::matches("^baby_birth_timestamp$"),
      .fns = ~ lubridate::ymd_hms(.x, tz = "America/Sao_Paulo")
    ),
    dplyr::across(
      .cols = -dplyr::all_of(c("id", "baby_birth_timestamp")),
      .fns = as.numeric
    ),
    dplyr::across(
      .cols = dplyr::matches("^apgar_"),
      .fns = as.integer
    )
  )

medical_record_data
```

```{r}
valid_cases <-
  field_form_data |>
  dplyr::left_join(
    control_data,
    by = "id"
  ) |>
  dplyr::left_join(
    sleep_data,
    by = "id"
  ) |>
  dplyr::left_join(
    medical_record_data,
    by = "id"
  ) |>
  dplyr::filter(birth_center_delivery == TRUE) |>
  tidyr::drop_na(labor_duration, baby_weight, fps_mean, waso_mean) |>
  dplyr::pull(id)

valid_cases
```

```{r}
general_data <-
  control_data |>
  dplyr::left_join(
    sleep_data,
    by = "id"
  ) |>
  dplyr::left_join(
    medical_record_data,
    by = "id"
  ) |>
  dplyr::left_join(
    field_form_data,
    by = "id"
  ) |>
  dplyr::mutate(
    waso_prop = (as.numeric(waso_mean)) / as.numeric(fps_mean)
  ) |>
  dplyr::filter(id %in% valid_cases)
```

## Exploring the Data

The actogram presented in the article was created using the [ActStudio](https://condorinst.com/en/actstudio-software/) software.

```{r}
general_data |> dplyr::glimpse()
```

### Qualitative Variables

```{r}
#| output: asis

general_data |> summarytools::freq(ethnicity, style = "rmarkdown")
```

```{r}
#| output: asis

general_data |> summarytools::freq(education,  style = "rmarkdown")
```

```{r}
#| output: asis

general_data |> summarytools::freq(solo,  style = "rmarkdown")
```

### Quantitative Variables

```{r}
#| output: asis

dplyr::tibble(
    min = general_data |> dplyr::pull(timestamp) |> min(),
    max = general_data |> dplyr::pull(timestamp) |> max(),
    int = lubridate::interval(min, max) |> as.period()
  ) |>
  t()
```

```{r}
#| output: asis

general_data |> summarytools::freq(awakenings_mean,  style = "rmarkdown")
```

```{r}
#| output: asis

general_data |>
  summarytools::descr(
    age,
    round.digits = 3,
    style = "rmarkdown"
  )
```

```{r}
#| output: asis

general_data |>
  summarytools::descr(
    family_income,
    round.digits = 3,
    style = "rmarkdown"
  )
```

```{r}
general_data |>
  rutils:::stats_summary(
    paste0("fps", "_", "mean"),
    threshold = NULL
    # threshold = hms::parse_hms("12:00:00")
  ) |>
  print(n = Inf)
```

```{r}
#| output: asis

general_data |>
  rutils:::stats_summary(
    paste0("fps", "_", "sd"),
    threshold = NULL
    # threshold = hms::parse_hms("12:00:00")
  ) |>
  print(n = Inf)
```

```{r}
general_data |>
  summarytools::descr(
    awakenings_sd,
    style = "rmarkdown"
  )
```

```{r}
#| output: asis

general_data |> summarytools::descr(labor_duration, style = "rmarkdown")
```

```{r}
general_data |> plotr:::plot_dist(col = "bmi_current")
```

```{r}
general_data |> plotr:::plot_box_plot(col = "bmi_current")
```

### Correlation Matrices

```{r}
general_data |>
  plotr:::plot_ggally(
    cols = c(
      "labor_duration", "age", "family_income", "bmi_before"
    ),
    labels = c(
      "Duração do parto", "Idade", "Renda familiar", "IMC"
    )
  )
```

```{r}
general_data |>
  plotr:::plot_ggally(
    cols = c(
      "labor_duration", "gestations", "deliveries", "abortions"
    ),
    labels = c(
      "Duração do parto", "# Gestações", "# Partos", "# Abortos"
    )
  )
```

```{r}
general_data |>
  plotr:::plot_ggally(
    cols = c(
      "labor_duration", "baby_weight", "baby_length",
      "baby_head_perimeter",  "baby_thoracic_perimeter",
      "baby_abdominal_perimeter"
    ),
    labels = c(
      "Duração do parto", "Peso do bebê", "Comprimento do bebê",
      "Per. da cabeça do bebê", "Per. torácico do bebê", "Per. abdominal do bebê"
    )
  )
```

```{r}
general_data |>
  plotr:::plot_ggally(
    cols = c("labor_duration", "fps_mean", "waso_mean", "awakenings_mean"),
    labels = c("Duração do parto", "FPS", "WASO", "Desp.")
  )
```

```{r}
general_data |>
  dplyr::mutate(
    his_mean = his_mean |> lubritime::link_to_timeline(),
    hfs_mean = hfs_mean |> lubritime::link_to_timeline()
  ) |>
  plotr:::plot_ggally(
    cols = c(
      "his_mean", "hfs_mean", "fps_mean", "tts_mean", "tts_fps_mean",
       "waso_mean", "awakenings_mean"
    ),
    labels = c(
      "HIS", "HFS", "FPS", "TTS", "TTS/FPS", "WASO", "Desp."
    )
  )
```

```{r}
#| eval: false

general_data |>
  plotr:::plot_ggally(
    cols = c(
      "fps_mean", "tts_mean", "waso_mean", "awakenings_mean",
      "age", "family_income", "bmi_before"
    ),
    labels = c(
      "FPS", "TTS", "WASO", "Desp.", "Idade", "Renda", "IMC"
    )
  )
```

```{r}
#| eval: false

grDevices::dev.off()
```
