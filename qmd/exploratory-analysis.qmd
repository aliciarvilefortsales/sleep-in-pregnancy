---
execute:
  eval: false
---

# Exploratory Analysis

```{r}
#| label: setup
#| include: false

library(here)

source(here("R", "_setup.R"))
```

## Set the Environment

### Load Packages

```{r}
#| output: false

library(actverse) # github.com/danielvartan/actverse
library(askpass)
library(car)
library(checkmate)
library(dplyr)
library(ggplot2)
library(googlesheets4)
library(grDevices)
library(here)
library(hms)
library(lubridate)
library(lubritime) # github.com/danielvartan/lubritime
library(orbis) # github.com/danielvartan/orbis
library(osfr)
library(plotr) # github.com/danielvartan/plotr
library(rutils) # github.com/danielvartan/rutils
library(scaler) # github.com/danielvartan/scaler
library(scales)
library(sodium)
library(stats)
library(stringr)
library(summarytools)
library(tidyr)
```

### Load Custom Functions

```{r}
source(here::here("R", "anonymize_id.R"))
```


```{r}
get_n <- function(data, group) {
  checkmate::assert_tibble(data)
  checkmate::assert_subset("group", names(data))
  checkmate::assert_set_equal(levels(data$group), c("Poor", "Good"))
  checkmate::assert_choice(group, c("Poor", "Good"))

  data |>
    dplyr::rename(.group = group) |>
    dplyr::filter(.group == group) |>
    nrow()
}
```

```{r}
get_labor_duration <- function(data, group) {
  checkmate::assert_tibble(data)
  checkmate::assert_subset(c("group", "labor_duration"), names(data))
  checkmate::assert_set_equal(levels(data$group), c("Poor", "Good"))
  checkmate::assert_choice(group, c("Poor", "Good"))

  data |>
    dplyr::rename(.group = group) |>
    dplyr::filter(.group == group) |>
    dplyr::pull(labor_duration)
}
```

```{r}
# See Maxwell et al. (2018, p. 150)

f_unb <- function(k, n_total, f_test) {
  checkmate::assert_int(k, lower = 2)
  checkmate::assert_int(n_total, lower = 2)
  checkmate::assert_number(f_test)

  ((k - 1) / n_total) %>%
  `*`(((n_total - k - 2) / (n_total - k)) * (f_test - 1)) |>
  sqrt()
}
```

### Set Keys

```{r}
#| eval: false
#| output: false

gs4_auth(cache = ".secrets")
```

## Setting Parameters

```{r}
#| eval: false
#| output: false

prettycheck:::assert_interactive()

googlesheets4::gs4_auth()
```

```{r}
#| eval: false

prettycheck:::assert_interactive()

osfr::osf_auth()
```

```{r}
private_key_path <- here::here("_ssh", "id_rsa")
```

```{r}
#| eval: false

password <- askpass::askpass()
```

```{r}
#| eval: false

salt <- askpass::askpass()
```

```{r}
public_key_path <- here::here("_ssh", "id_rsa.pub")
```

## Getting Data from Google Sheets

The following are internal data collected and organized using a Google Form to facilitate the management of the study.

```{r}
#| output: false

control_form <- googlesheets4::read_sheet(
  ss = "13wtDr4fRD1wJSM-qdLOdGSchF8oXU1bG0Jtccu24GhY",
  sheet = "Dataset",
  col_types = "c"
)
```

The following are data extracted from the Google Form used to collect data from the participants of the study.

```{r}
#| output: false

field_form <- googlesheets4::read_sheet(
  ss = "1tY_TT0nPXFsErYQS2VED0-hqTzgHudA9BfhRhYG19fw",
  sheet = "Dataset",
  col_types = "c"
)
```

The sleep data were extracted using the Condor Instrument [ActStudio](https://condorinst.com/en/actstudio-software/) software and subsequently formatted in Google Sheets for further analysis.

```{r}
#| output: false

sleep_input <- googlesheets4::read_sheet(
  ss = "1iqjhdSiWYr9RYSvIvJQfFw35DR31YA_oj2SW8iR5WPw",
  sheet = "Dataset",
  col_types = "c"
)
```

Medical records were obtained from participants' medical files and organized in Google Sheets for subsequent analysis.

```{r}
#| output: false

medical_record_input <- googlesheets4::read_sheet(
  ss = "10yvvTOCjZsRKPO8A4yn0NCvWe4Jn_Kq-Zu_CV4miGJI",
  sheet = "Dataset",
  col_types = "c"
)
```

## Processing the Google Sheets Data

```{r}
control_data <-
  control_form |>
  `names<-`(paste0("X", seq_along(control_form))) |>
  dplyr::select(X5, X6, X7, X12, X13, X14) |>
  dplyr::rename(
    cpf = X5,
    id = X6,
    name = X7,
    birth_center_delivery = X12,
    birth = X13,
    labor_start = X14
  ) |>
  dplyr::mutate(
    birth_center_delivery = dplyr::case_when(
      tolower(trimws(birth_center_delivery)) == "sim" ~ TRUE,
      tolower(trimws(birth_center_delivery)) == "não" ~ FALSE,
      TRUE ~ NA
    ),
    birth = lubridate::as_datetime(birth),
    labor_start = lubridate::as_datetime(labor_start)
  ) |>
  dplyr::mutate(
    labor_duration =
      lubridate::interval(
        start = labor_start,
        end = birth
      ) |>
        lubritime::int_duration()
  ) |>
  dplyr::filter(!is.na(labor_duration)) |>
  dplyr::select(id, birth_center_delivery, labor_start, labor_duration)

control_data
```

```{r}
field_form_data <-
  field_form |>
  `names<-`(paste0("X", seq_along(field_form))) |>
  dplyr::select(
    X1, X4, X5, X11, X91, X92, X95, X96, X97, X99, X101, X102, X106, X119,
    X118, X125, X126
  ) |>
  dplyr::rename(
    timestamp = X1,
    birth_date = X4,
    cpf = X5,
    weight_before = X96,
    weight_current = X95,
    height = X97,
    ethnicity = X106,
    education = X118,
    family_income = X99,
    health_plan = X101,
    solo = X102,
    exercise = X119,
    work = X92,
    study = X91,
    gestations = X11,
    deliveries = X125,
    abortions = X126
  ) |>
  dplyr::mutate(
    id = anonymize_id(cpf, salt),
    timestamp = lubridate::mdy_hms(timestamp),
    birth_date = lubridate::dmy(birth_date),
    age = scaler:::age(birth_date, timestamp),
    ethnicity = factor(
      ethnicity,
      levels = c(
        "Indígena",
        "Preta",
        "Parda",
        "Amarela",
        "Branca"
      ),
      ordered = TRUE
    ),
    education = factor(
      education,
      levels = c(
        "Não frequentou a escola",
        "Fundamental incompleto",
        "Fundamental completo",
        "Ensino médio incompleto",
        "Ensino médio completo",
        "Ensino superior incompleto",
        "Ensino superior completo",
        "Mestrado incompleto",
        "Mestrado completo",
        "Doutorado incompleto",
        "Doutorado completo",
        "Pós-doutorado incompleto",
        "Pós-doutorado completo"
      ),
      ordered = TRUE
    ),
    gestations = dplyr::case_match(
      gestations,
      c("Sim", "0") ~ "1",
      "Não" ~ "0",
      .default = gestations
    ),
    deliveries = dplyr::case_when(
      is.na(deliveries) ~ "0",
      TRUE ~ deliveries
    ),
    abortions = dplyr::case_when(
      is.na(abortions) ~ "0",
      TRUE ~ abortions
    )
  ) |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::all_of(
        c(
          "weight_before", "weight_current", "height",
          "family_income", "gestations", "deliveries",
          "abortions"
        )
      ),
      .fns = as.numeric
    )
  ) |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::all_of(
        c("health_plan", "solo", "exercise", "work", "study")
      ),
      .fns = function(x) {
        dplyr::case_match(
          x,
          "Sim" ~ TRUE,
          "Não" ~ FALSE
        )
      }
    )
  ) |>
  dplyr::mutate(
    gestations = dplyr::case_when(
      id == "ae5fc5cd" ~ 3,
      TRUE ~ gestations
    ),
  ) |>
  dplyr::mutate(
    bmi_before = weight_before / ((height / 100)^2),
    bmi_current = weight_current / ((height / 100)^2)
  ) |>
  dplyr::select(-cpf) |>
  dplyr::relocate(
    id, timestamp, birth_date, age, weight_before, weight_current, height, bmi_before, bmi_current, family_income
  )

field_form_data
```

```{r}
sleep_data <-
  sleep_input |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::matches("^his_|^hfs_|^fps_|^tts_m|^tts_sd|^waso_"),
      .fns = hms::parse_hms
    ),
    dplyr::across(
      .cols = dplyr::matches("^tts_fps_|^awakenings_"),
      .fns = as.numeric
    )
  )

sleep_data
```

```{r}
medical_record_data <-
  medical_record_input |>
  dplyr::mutate(
    dplyr::across(
      .cols = dplyr::all_of(c("partograph_begin", "baby_birth")),
      .fns = ~ lubridate::ymd_hms(.x, tz = "America/Sao_Paulo")
    ),
    dplyr::across(
      .cols = -dplyr::all_of(c("id", "partograph_begin", "baby_birth")),
      .fns = as.numeric
    ),
    dplyr::across(
      .cols = dplyr::matches("^begin_dilation$|^apgar_"),
      .fns = as.integer
    )
  ) |>
  dplyr::mutate(
    partogram_duration =
      lubridate::interval(
        start = partograph_begin,
        end = baby_birth
      ) |>
        lubritime::int_duration()
  )

medical_record_data
```

```{r}
valid_cases <-
  field_form_data |>
  dplyr::left_join(
    control_data,
    by = "id"
  ) |>
  dplyr::left_join(
    sleep_data,
    by = "id"
  ) |>
  dplyr::left_join(
    medical_record_data,
    by = "id"
  ) |>
  dplyr::filter(birth_center_delivery == TRUE) |>
  tidyr::drop_na(labor_duration, baby_weight, fps_mean, waso_mean) |>
  dplyr::pull(id)

valid_cases
```

```{r}
general_data <-
  control_data |>
  dplyr::left_join(
    sleep_data,
    by = "id"
  ) |>
  dplyr::left_join(
    medical_record_data,
    by = "id"
  ) |>
  dplyr::left_join(
    field_form_data,
    by = "id"
  ) |>
  dplyr::mutate(
    waso_prop = (as.numeric(waso_mean)) / as.numeric(fps_mean)
  ) |>
  dplyr::filter(id %in% valid_cases)
```

## Getting Data from OSF

```{r}
data_dir <- here::here("data")
```

```{r}
if (!dir.exists(data_dir)) dir.create(data_dir)
```

```{r}
valid_cases_pattern <- paste0("^", valid_cases, collapse = "|")
```

```{r}
osf_processed_data_id <- "a2dsw"
```

```{r}
osf_processed_data_id |>
  osfr::osf_retrieve_node() |>
  osfr::osf_ls_files(n_max = Inf) |>
  dplyr::filter(name == "actigraphy") |>
  dplyr::pull(id) |>
  osfr::osf_retrieve_file() |>
  osfr::osf_ls_files(n_max = Inf) |>
  dplyr::filter(stringr::str_detect(name, valid_cases_pattern)) |>
  dplyr::filter(stringr::str_detect(name, "actigraphy-processed-data")) |>
  osfr::osf_download(
    path = data_dir,
    conflicts = "overwrite",
    progress = TRUE
  )
```

```{r}
osf_raw_data_id <- "7kg34"
```

```{r}
osf_raw_data_id |>
  osfr::osf_retrieve_node() |>
  osfr::osf_ls_files(n_max = Inf) |>
  dplyr::filter(name == "medical-record") |>
  dplyr::pull(id) |>
  osfr::osf_retrieve_file() |>
  osfr::osf_ls_files(n_max = Inf) |>
  dplyr::filter(stringr::str_detect(name, valid_cases_pattern)) |>
  osfr::osf_download(
    path = data_dir,
    conflicts = "overwrite",
    progress = TRUE
  )
```

```{r}
valid_cases |>
  setdiff(
    test |>
    dplyr::pull(name) |>
    stringr::str_extract(".*(?=_medical)")
  )
```

```{r}
data_dir |>
  lockr::unlock_dir(
    private_key = private_key_path,
    password = password
  )
```

## Exploring the Data

The actogram presented in the article was created using the [ActStudio](https://condorinst.com/en/actstudio-software/) software.

```{r}
general_data |> dplyr::glimpse()
```

### Qualitative Variables

```{r}
#| output: asis

general_data |> summarytools::freq(ethnicity, style = "rmarkdown")
```

```{r}
#| output: asis

general_data |> summarytools::freq(education,  style = "rmarkdown")
```

```{r}
#| output: asis

general_data |> summarytools::freq(solo,  style = "rmarkdown")
```

### Quantitative Variables

```{r}
#| output: asis

dplyr::tibble(
    min = general_data |> dplyr::pull(timestamp) |> min(),
    max = general_data |> dplyr::pull(timestamp) |> max(),
    int = lubridate::interval(min, max) |> as.period()
  ) |>
  t()
```

```{r}
#| output: asis

general_data |> summarytools::freq(awakenings_mean,  style = "rmarkdown")
```

```{r}
#| output: asis

general_data |>
  summarytools::descr(
    age,
    round.digits = 3,
    style = "rmarkdown"
  )
```

```{r}
#| output: asis

general_data |>
  summarytools::descr(
    family_income,
    round.digits = 3,
    style = "rmarkdown"
  )
```

```{r}
general_data |>
  rutils:::stats_summary(
    paste0("hfs", "_", "mean"),
    threshold = NULL
    # threshold = hms::parse_hms("12:00:00")
  ) |>
  print(n = Inf)
```

```{r}
#| output: asis

general_data |>
  rutils:::stats_summary(
    paste0("hfs", "_", "sd"),
    threshold = NULL
    # threshold = hms::parse_hms("12:00:00")
  ) |>
  print(n = Inf)
```

```{r}
general_data |>
  summarytools::descr(
    awakenings_sd,
    style = "rmarkdown"
  )
```

```{r}
#| output: asis

general_data |> summarytools::descr(labor_duration, style = "rmarkdown")
```

```{r}
general_data |> plotr:::plot_dist(col = "bmi_current")
```

```{r}
general_data |> plotr:::plot_box_plot(col = "bmi_current")
```

## Partogram Duration Model

```{r}
form <- formula(partogram_duration ~ begin_dilation + baby_head_perimeter + baby_abdominal_perimeter)

# baby_weight
# baby_length
# baby_head_perimeter
# baby_thoracic_perimeter
# baby_abdominal_perimeter
```

```{r}
model <-
  parsnip::linear_reg() |>
  parsnip::set_engine("lm")
```

```{r}
fit <-
  model |>
  parsnip::fit(
    formula = form,
    data = medical_record_data
  )
```

```{r}
fit |>
  broom::tidy() |>
  print(n = Inf)
```

```{r}
fit |>
  broom::glance() |>
  tidyr::pivot_longer(cols = dplyr::everything()) |>
  print(n = Inf)
```

```{r}
fit_augment <- fit |> broom::augment(new_data = medical_record_data)
```

```{r}
fit_error <-
  fit_augment |>
  dplyr::transmute(
    .pred = .pred,
    .resid = .resid,
    partogram_duration = partogram_duration |> as.numeric(),
    error = .resid / partogram_duration
  )
```

```{r}
fit_augment <-
  fit |>
  broom::augment(
    new_data = dplyr::tibble(
      begin_dilation = 1
    )
  )
```

```{r}
medical_record_data |>
  ggplot2::ggplot(
    ggplot2::aes(
      x = partogram_duration,
      y = begin_dilation
    )
  ) +
  ggplot2::geom_point() +
  ggplot2::geom_smooth(
    method = "lm",
    color = "#FC2913"
  ) +
  ggplot2::labs(
    x = "Duração do partograma (h)",
    y = "Dilat. do colo do útero (cm)"
  ) +
  ggplot2::scale_x_time()

```

### Correlation Matrices

```{r}
general_data |>
  plotr:::plot_ggally(
    cols = c(
      "labor_duration", "age", "family_income", "bmi_before"
    ),
    labels = c(
      "Duração do parto", "Idade", "Renda familiar", "IMC"
    )
  )
```

```{r}
general_data |>
  plotr:::plot_ggally(
    cols = c(
      "labor_duration", "gestations", "deliveries", "abortions"
    ),
    labels = c(
      "Duração do parto", "# Gestações", "# Partos", "# Abortos"
    )
  )
```

```{r}
general_data |>
  plotr:::plot_ggally(
    cols = c(
      "labor_duration", "baby_weight", "baby_length",
      "baby_head_perimeter",  "baby_thoracic_perimeter",
      "baby_abdominal_perimeter"
    ),
    labels = c(
      "Duração do parto", "Peso do bebê", "Comprimento do bebê",
      "Per. da cabeça do bebê", "Per. torácico do bebê", "Per. abdominal do bebê"
    )
  )
```

```{r}
general_data |>
  plotr:::plot_ggally(
    cols = c("labor_duration", "fps_mean", "waso_mean", "awakenings_mean"),
    labels = c("Duração do parto", "FPS", "WASO", "Desp.")
  )
```

```{r}
general_data |>
  dplyr::mutate(
    his_mean = his_mean |> lubritime::link_to_timeline(),
    hfs_mean = hfs_mean |> lubritime::link_to_timeline()
  ) |>
  plotr:::plot_ggally(
    cols = c(
      "his_mean", "hfs_mean", "fps_mean", "tts_mean", "tts_fps_mean",
       "waso_mean", "awakenings_mean"
    ),
    labels = c(
      "HIS", "HFS", "FPS", "TTS", "TTS/FPS", "WASO", "Desp."
    )
  )
```

```{r}
#| eval: false

general_data |>
  plotr:::plot_ggally(
    cols = c(
      "fps_mean", "tts_mean", "waso_mean", "awakenings_mean",
      "age", "family_income", "bmi_before"
    ),
    labels = c(
      "FPS", "TTS", "WASO", "Desp.", "Idade", "Renda", "IMC"
    )
  )
```

```{r}
#| eval: false

grDevices::dev.off()
```

### Actograms

```{r}
actigraphy_data <-
  here::here("data") |>
  fs::dir_ls(type = "file") |>
  stringr::str_subset(paste0("f1e30a89")) |>
  actverse::read_acttrust(tz = "America/Sao_Paulo")
```

```{r}
actigraphy_data |>
  actverse::actogram(
    days = -1,
    latitude = orbis::get_brazil_state_latitude("sp"),
    longitude = orbis::get_brazil_state_longitude("sp")
    # locale = "pt_BR.UTF-8",
    # x_label = "2 Dias — Horas",
    # y_label = "Dias",
    # labels = c(
    #   "1" = "Sono",
    #   "2" = "Despertar",
    #   "4" = "Offwrist",
    #   "base" = "Atividade (PIM)",
    #   "lp" = "Fase clara",
    #   "dp" = "Fase escura"
    # ),
    # colors = c(
    #   "1" = "#410085",
    #   "2" = "#FFB426",
    #   "4" = "#FC2913",
    #   "base" = "#000040",
    #   "lp" = "#FFFFFF",
    #   "dp" = "#DBD7D3"
    # )
  )
```

### Sleep Irregularity Index (SRI)

```{r}
sri_data <- actigraphy_data |> actverse::sri()

sri_data
```

```{r}
sri_data |>
  rutils:::stats_summary("sri", threshold = NULL) |>
  print(n = Inf)
```

```{r}
sri_data |>
  dplyr::filter(sri > 0) |>
  rutils:::stats_summary("sri", threshold = NULL) |>
  print(n = Inf)
```

```{r}
if (min(sri_data$sri) < 0) {
  y_scale <- \() ggplot2::scale_y_continuous(limits = c(NA, 100))
} else {
  y_scale <- \() ggplot2::scale_y_continuous(limits = c(0, 100))
}

y_scale

sri_data |>
  ggplot2::ggplot(ggplot2::aes(x = time, y = sri)) +
  ggplot2::geom_smooth(color = "#FC2913") +
  ggplot2::labs(
    x = "Time of day (Hour)",
    y = "Sleep Regularity Index (SRI)"
  ) +
  ggplot2::scale_x_time(
    breaks = scales::breaks_width("6 hours"),
    labels = scales::label_time("%-H") # Use "%#H" for Windows
  ) +
  y_scale()
```

### Percentage of Time Asleep

```{r}
sleep_prop_data <-
  actigraphy_data |>
  actverse::state_prop(state_values = 1)

sleep_prop_data
```

```{r}
sleep_prop_data |>
  rutils:::stats_summary("prop", threshold = NULL) |>
  print(n = Inf)
```

```{r}
sleep_prop_data |>
  dplyr::mutate(per = prop * 100) |>
  ggplot2::ggplot(ggplot2::aes(x = time, y = per)) +
  ggplot2::geom_smooth(color = "#FC2913") +
  ggplot2::labs(
    x = "Time of day (Hour)",
    y = "Percentage of time asleep (%)",
  ) +
  ggplot2::scale_x_time(
    breaks = scales::breaks_width("6 hours"),
    labels = scales::label_time("%-H") # Use "%#H" for Windows
  ) +
  ggplot2::scale_y_continuous(limits = c(0, 100))
```

### Groups

```{r}
group_data <-
  control_data |>
  dplyr::left_join(
    sleep_data,
    by = "id"
  ) |>
  dplyr::left_join(
    medical_record_data,
    by = "id"
  ) |>
  dplyr::filter(id %in% valid_cases) |>
  dplyr::select(labor_duration, fps_mean, waso_mean, baby_weight) |>
  tidyr::drop_na() |>
  dplyr::mutate(
    waso_prop = (as.numeric(waso_mean)) / as.numeric(fps_mean),
    group_fps =
      dplyr::case_when(
        fps_mean < hms::parse_hm("07:00") ~ "<7h (Poor)",
        fps_mean >= hms::parse_hm("07:00") ~ ">7h (Good)"
      ) |>
      factor(levels = c("<7h (Poor)", ">7h (Good)")),
    group_waso =
      dplyr::case_when(
        waso_prop > 0.1 ~ ">10% (Poor)",
        waso_prop < 0.1 ~ "<10% (Good)"
      ) |>
      factor(levels = c(">10% (Poor)", "<10% (Good)"))
  ) |>
  tidyr::drop_na()
```

::: {#tbl-pa-groups}
```{r}
row_list <- list(
  c("group_waso", ">10% (Poor)"),
  c("group_waso", "<10% (Good)"),
  c("group_fps", "<7h (Poor)"),
  c("group_fps", ">7h (Good)")
)

out <- dplyr::tibble()

for (i in row_list) {
  out <-
    out |>
    dplyr::bind_rows(
    dplyr::tibble(
      n =
        group_data |>
        dplyr::filter(!!as.symbol(i[1]) == i[2]) |>
        nrow(),
      mean =
        group_data |>
        dplyr::filter(!!as.symbol(i[1]) == i[2]) |>
        dplyr::pull(labor_duration) |>
        as.numeric() |>
        mean(na.rm = TRUE),
      sd =
        group_data |>
        dplyr::filter(!!as.symbol(i[1]) == i[2]) |>
        dplyr::pull(labor_duration) |>
        as.numeric() |>
        stats::sd(na.rm = TRUE),
      labor_duration = paste0(
        mean |>
          hms::as_hms() |>
          lubritime::round_time() |>
          as.character(),
        " ± ",
        sd |>
          hms::as_hms() |>
          lubritime::round_time() |>
          as.character()
      )
    ) |>
      dplyr::mutate(group = i[2]) |>
      dplyr::select(group, everything())
  )
}

out |>
  dplyr::select(n, labor_duration) |>
  as.data.frame() %>%
  `row.names<-`(
    c(
      "WASO >10% (Poor)",
      "WASO <10% (Good)",
      "FPS <7h (Poor)",
      "FPS >7h (Good)"
    )
  )
```

Diferenças na duração do trabalho de parto em função do tempo acordado após o início do sono (Wake After Sleep Onset (WASO)) e da duração do sono (Fase Principal do Sono (FSP)).  NA = Não disponível (Not Available). ($n = 8$).

[Source: Created by the author]{.legend}
:::

#### FSP

```{r}
#| eval: false

group_data |>
  plot_ggally(
    cols = c("labor_duration", "baby_weight", "fps_mean", "group_fps"),
    mapping = ggplot2::aes(color = group_fps)
  )
```

::: {#fig-pa-waso-baby-weight-scatterplot}
```{r}
group_data |>
  dplyr::mutate(
    labor_duration =
      labor_duration |>
      as.numeric() |>
      hms::as_hms(),
    group_fps = dplyr::case_match(
      group_fps,
      "<7h (Poor)" ~ "<7h (Ruim)",
      ">7h (Good)" ~ ">7h (Bom)"
    )
  ) |>
  ggplot2::ggplot(
    ggplot2::aes(
      x = labor_duration,
      y = baby_weight,
      color = group_fps
    )
  ) +
  ggplot2::geom_point() +
  ggplot2::stat_smooth(method = lm) +
  ggplot2::labs(
    x = "Duração do parto",
    y = "Peso do bebê (g)",
    color = "FPS"
  ) +
  ggplot2::scale_x_continuous(labels = labels_hms) +
  viridis::scale_color_viridis(end = 0.5, discrete = TRUE)
```

Relação da variável `labor_duration` (Duração do parto) com a covariante `baby_weight` (Peso do bebê) (gramas) por grupos com duração de sono baixa/ruim (<7h) (cor roxa) e com duração de sono boa/adequada (>7h) (cor verde). `<br>`{=html} A duração do sono foi medida por meio da média da Fase Principal de Sono (FSP) nos últimos sete dias que antecederam o parto. As linhas representam regressões lineares. A área cinza representa o intervalo de confiança da estimativa.

[Fonte: Elaborado pela autora.]{.legend}
:::

#### WASO

```{r}
#| eval: false

group_data |>
  plot_ggally(
    cols = c("labor_duration", "baby_weight", "waso_prop", "group_waso"),
    mapping = ggplot2::aes(color = group_waso)
  )
```

::: {#fig-pa-waso-baby-weight-scatterplot}
```{r}
group_data |>
  dplyr::mutate(
    labor_duration =
      labor_duration |>
      as.numeric() |>
      hms::as_hms(),
    group_waso = dplyr::case_match(
      group_waso,
      ">10% (Poor)" ~ ">10% (Ruim)",
      "<10% (Good)" ~ "<10% (Bom)"
    )
  ) |>
  ggplot2::ggplot(
    ggplot2::aes(
      x = labor_duration,
      y = baby_weight,
      color = group_waso
    )
  ) +
  ggplot2::geom_point() +
  ggplot2::stat_smooth(method = lm) +
  ggplot2::labs(
    x = "Duração do parto",
    y = "Peso do bebê (g)",
    color = "WASO"
  ) +
  ggplot2::scale_x_continuous(labels = labels_hms) +
  viridis::scale_color_viridis(end = 0.5, discrete = TRUE, direction = -1) +
  ggplot2::guides(color = ggplot2::guide_legend(reverse = TRUE))
```

Relação da variável `labor_duration` (Duração do parto) com a covariante `baby_weight` (Peso do bebê) (em gramas) por grupos com baixa qualidade de sono (>10% de WASO/FPS) (cor roxa) e com qualidade de sono boa/adequada (<10% de WASO/FPS) (cor verde). `<br>`{=html} Os dados se referem aos últimos sete dias que antecederam o parto. FPS = Fase Principal do Sono, representando a duração do período entre o horário de início do sono e o horário final do sono. WASO = Wake After Sleep Onset ou tempo acordado após o início do sono, usado como proxy para medir a qualidade do sono. As linhas representam regressões lineares. A área em cinza representa o intervalo de confiança da estimativa.

[Fonte: Elaborado pela autora.]{.legend}
:::

## Hypothesis Testing

> Variável dependente: `labor_duration`

$$
\begin{cases}
\text{H}_{0}: \overline{X}_{\text{Ruim}} <= \overline{X}_{\text{Bom}} \\
\text{H}_{a}: \overline{X}_{\text{Ruim}} > \overline{X}_{\text{Bom}}
\end{cases}
$$

> See @ellis2010 to learn more about Hedges' g and other effect size measures.

$$
\text{g de Hedges} = \cfrac{\overline{\text{X}}_{\text{Ruim}} - \overline{\text{X}}_{\text{Bom}}}{\text{SD}_{\text{pooled}}}
$$

```{r}
model_data <-
  control_data |>
  dplyr::left_join(
    sleep_data,
    by = "id"
  ) |>
  dplyr::left_join(
    medical_record_data,
    by = "id"
  ) |>
  dplyr::filter(id %in% valid_cases) |>
  dplyr::select(labor_duration, fps_mean, waso_mean, baby_weight) |>
  tidyr::drop_na()

model_data
```

### FPS (Fase Principal do Sono) (Main Sleep Phase)

::: {.callout-tip}
#### Consensus Statement

- Adults should sleep 7 or more hours per night on a regular basis to promote optimal health.
- Sleeping less than 7 hours per night on a regular basis is associated with adverse health outcomes, including weight gain and obesity, diabetes, hypertension, heart disease and stroke, depression, and increased risk of death. Sleeping less than 7 hours per night is also associated with impaired immune function, increased pain, impaired performance, increased errors, and greater
risk of accidents.
- Sleeping more than 9 hours per night on a regular basis may be appropriate for young adults, individuals recovering from sleep debt, and individuals with illnesses. For others, it is uncertain whether sleeping more than 9 hours per night is associated with health risk.
- People concerned they are sleeping too little or too much should consult their healthcare provider.

[@watson2015b]
:::

```{r}
model_data_fps <-
  model_data |>
  dplyr::select(labor_duration, fps_mean, baby_weight) |>
  dplyr::mutate(
    group =
      dplyr::case_when(
        fps_mean < hms::parse_hm("07:00") ~ "Poor",
        fps_mean >= hms::parse_hm("07:00") ~ "Good"
      ) |>
      factor(levels = c("Poor", "Good"))
  ) |>
  dplyr::mutate(
    labor_duration = as.numeric(labor_duration)
  ) |>
  dplyr::relocate(group) |>
  dplyr::select(group, labor_duration, baby_weight) |>
  tidyr::drop_na()

model_data_fps
```

```{r}
model_data_fps |> report::report()
```

#### Welch's T-Test

##### Power Analysis (*a posteriori*)

::: {.callout-info}
See the *a priori* power analysis at <https://danielvartan.github.io/sample-size>.
:::

Desired power: $(1 - \beta) \geq 0.8$

```{r}
# A posteriori

pwr_analysis_fps_anconva <- pwrss::pwrss.t.2means(
  mu1 = model_data_fps |> get_labor_duration("Poor") |> mean(na.rm = TRUE),
  mu2 = model_data_fps |> get_labor_duration("Good") |> mean(na.rm = TRUE),
  sd1 = model_data_fps |> get_labor_duration("Poor") |> stats::sd(na.rm = TRUE),
  sd2 = model_data_fps |> get_labor_duration("Good") |> stats::sd(na.rm = TRUE),
  paired = FALSE,
  n2 = model_data_fps |> get_n("Good"),
  kappa = get_n(model_data_fps, "Poor") / get_n(model_data_fps, "Good"),
  power = NULL,
  alpha = 0.05,
  welch.df = TRUE,
  alternative = "superior"
)
```

<!-- Add power analysis plot -->

##### Test

```{r}
model_t_test_fps <- stats::t.test(
  x = model_data_fps |> get_labor_duration("Poor"),
  y = model_data_fps |> get_labor_duration("Good"),
  alternative = "greater"
)

model_t_test_fps
```

```{r}
report::report(model_t_test_fps)
```

##### Effect Size

```{r}
dplyr::tibble(
  fps_mean_poor =
    model_data_fps |>
    get_labor_duration("Poor") |>
    mean(na.rm = TRUE) |>
    hms::as_hms(),
  fps_mean_good =
    model_data_fps |>
    get_labor_duration("Good") |>
    mean(na.rm = TRUE) |>
    hms::as_hms(),
  diff = (fps_mean_poor - fps_mean_good) |> hms::as_hms()
)
```

```{r}
effectsize::cohens_d(
  x = model_data_fps |> get_labor_duration("Poor"),
  y = model_data_fps |> get_labor_duration("Good"),
  pooled_sd = TRUE,
  mu = 0,
  paired = FALSE,
  adjust = TRUE, # For small samples
  ci = 0.95,
  alternative = "greater",
  verbose = TRUE
) |>
  effectsize::interpret_hedges_g()
```

#### ANCOVA

> See @rutherford2011[pp. 237-261] to lear more about ANOVA-ANCOVA assumptions.

##### Test

```{r}
model_aov_fps <- stats::aov(
  formula = labor_duration ~ baby_weight * group,
  data = model_data_fps
)

model_aov_fps
```

```{r}
model_aov_fps |> summary()
```

```{r}
model_aov_fps |> report::report()
```

##### Effect Size

Veja @cohen1992 para saber mais.

Tamanho de efeito para duraçõa do parto e FSP encontrado por @lee2004a:

```{r}
k <- 3
num_df <- 2
den_df <- 125
n_total_tst <- den_df + k
f_test <- 5.54

f_unb_tst <- f_unb(k, n_total_tst, f_test)

f_unb_tst
```

Tamanho de efeito *a posteriori*:

```{r}
effect_size_aov_fps <-
  model_aov_fps |>
  effectsize::cohens_f(
    partial = FALSE,
    generalized = FALSE,
    method = "eta",
    model2 = NULL,
    ci = 0.95,
    alternative = "greater",
    verbose = TRUE,
  ) |>
  effectsize::interpret_eta_squared("cohen1992")

effect_size_aov_fps
```

##### Power Analysis (*a posteriori*)

::: {.callout-info}
Veja a análise de poder *a priori* em: <https://danielvartan.github.io/sample-size>.
:::

Poder desejado: $(1 - \beta) \geq 0.8$

```{r}
# A posteriori

pwr_analysis_fps_anconva <- pwrss::pwrss.f.ancova(
  f2 = effect_size_aov_fps$Cohens_f[3]^2,
  n.way = 1,
  n.levels = 2,
  n.covariates = 1,
  # Not really true, since each group has a different number of observations.
  n = model_data_fps |>
    get_labor_duration("Good") |>
    length(),
  alpha = 0.05,
  verbose = TRUE
)

pwr_analysis_fps_anconva
```

<!-- Add power analysis plot -->

### WASO (Wake After Sleep Onset)

> As an estimate of sleep disruption, WASO is reported as the percentage of minutes awake divided by minutes in bed after falling asleep. During a typical 7- to 8-hour sleep period, WASO of 15% represents more than an hour of wake time after falling asleep. WASO between 5% and 10% is typical in healthy, nonpregnant women5 and greater than 15% was considered severe sleep disruption for this study.[@lee2004a[p. 2042]].

```{r}
model_data_waso <-
  model_data |>
  dplyr::select(labor_duration, waso_mean, fps_mean, baby_weight) |>
  dplyr::mutate(
    waso_prop = (as.numeric(waso_mean)) / as.numeric(fps_mean)
  ) |>
  dplyr::mutate(
    group =
      dplyr::case_when(
        waso_prop > 0.1 ~ "Poor",
        waso_prop < 0.1 ~ "Good"
      ) |>
      factor(levels = c("Poor", "Good"))
  ) |>
  dplyr::mutate(
    labor_duration = as.numeric(labor_duration)
  ) |>
  dplyr::relocate(group) |>
  dplyr::select(group, labor_duration, baby_weight) |>
  tidyr::drop_na()

model_data_waso
```

```{r}
model_data_waso |> report::report()
```

#### Welch's T-Test

##### Power Analysis (*a posteriori*)

::: {.callout-info}
See the *a priori* power analysis at <https://danielvartan.github.io/sample-size>.
:::

Desired power: $(1 - \beta) \geq 0.8$

```{r}
#| eval: false

# A posteriori

pwr_analysis_waso_t_test <- pwrss::pwrss.t.2means(
  mu1 = model_data_waso |>
    get_labor_duration("Poor") |>
    mean(na.rm = TRUE),
  mu2 = model_data_waso |>
    get_labor_duration("Good") |>
    mean(na.rm = TRUE),
  sd1 = model_data_waso |>
    get_labor_duration("Poor") |>
    stats::sd(na.rm = TRUE),
  sd2 = model_data_waso |>
    get_labor_duration("Good") |>
    stats::sd(na.rm = TRUE),
  paired = FALSE,
  n2 = model_data_waso |> get_n("Good"),
  kappa = get_n(model_data_waso, "Poor") / get_n(model_data_waso, "Good"),
  power = NULL,
  alpha = 0.05,
  welch.df = TRUE,
  alternative = "superior"
)
```

<!-- Add power analysis plot -->

##### Test

```{r}
#| eval: false

model_t_test_waso <- stats::t.test(
  x = model_data_waso |> get_labor_duration("Poor"),
  y = model_data_waso |> get_labor_duration("Good"),
  alternative = "greater"
)

model_t_test_waso
```

```{r}
#| eval: false

report::report(model_t_test_waso)
```

##### Effect Size

```{r}
dplyr::tibble(
  waso_mean_poor =
    model_data_waso |>
    get_labor_duration("Poor") |>
    mean(na.rm = TRUE) |>
    hms::as_hms(),
  waso_mean_good =
    model_data_waso |>
    get_labor_duration("Good") |>
    mean(na.rm = TRUE) |>
    hms::as_hms(),
  diff = (waso_mean_poor - waso_mean_good) |> hms::as_hms()
)
```

```{r}
effectsize::cohens_d(
  x = model_data_waso |> get_labor_duration("Poor"),
  y = model_data_waso |> get_labor_duration("Good"),
  pooled_sd = TRUE,
  mu = 0,
  paired = FALSE,
  adjust = TRUE, # For small samples
  ci = 0.95,
  alternative = "greater",
  verbose = TRUE
) |>
  effectsize::interpret_hedges_g()
```

#### ANCOVA

##### Test

```{r}
model_aov_waso <- stats::aov(
  formula = labor_duration ~ baby_weight * group,
  data = model_data_waso
)

model_aov_waso
```

```{r}
model_aov_waso |> summary()
```

```{r}
model_aov_waso |> report::report()
```

##### Effect Size

Veja @cohen1992 para saber mais.

Tamanho de efeito para duração do parto e WASO encontrado por @lee2004a:

```{r}
k <- 3
num_df <- 2
den_df <- 125
n_total_waso <- den_df + k
f_test <- 6.93

f_unb_waso <- f_unb(k, n_total_waso, f_test)

f_unb_waso
```

Tamanho de efeito *a posteriori*:

```{r}
effect_size_aov_waso <-
  model_aov_waso |>
  effectsize::cohens_f(
    partial = FALSE,
    method = "eta",
    model2 = NULL,
    ci = 0.95,
    alternative = "greater",
    verbose = TRUE,
  ) |>
  effectsize::interpret_eta_squared("cohen1992")

effect_size_aov_waso
```

##### Power Analysis (*a posteriori*)

::: {.callout-info}
Veja a análise de poder *a priori* em: <https://danielvartan.github.io/sample-size>.
:::

Poder desejado: $(1 - \beta) \geq 0.8$

```{r}
#| eval: false

pwr_analysis_waso_ancova <- pwrss::pwrss.f.ancova(
  f2 = effect_size_aov_waso$Cohens_f[3]^2,
  n.way = 1,
  n.levels = 2,
  n.covariates = 1,
  # Not really true, since each group has a different number of observations.
  n = model_data_waso |>
    get_labor_duration("Poor") |>
    length(),
  alpha = 0.05,
  verbose = FALSE
)

pwr_analysis_waso_ancova
```

<!-- Add power analysis plot -->

## ANCOVA Assumptions

Assumption 1
: **Predictor is known** (ANOVA). Each condition contains a random sample of the population of such scores [@rutherford2011[p. 237]].

Assumption 2
: **Normality** (ANOVA). The scores in each condition are distributed normally [@rutherford2011[p. 237]].

Assumption 3
: **Independence** (ANOVA). The scores in each condition are independent of each other [@rutherford2011[p. 237]].

Assumption 4
: **Common variance** (homoscedasticity) (ANOVA). The variances of the scores in each experimental condition are homogeneous [@rutherford2011[p. 237]].

Assumption 5
: **Independence of the covariates** (homoscedasticity) (ANCOVA). The covariate is independent of the treatments [@rutherford2011[p. 237]].

Assumption 6
: **Linear mean** (ANCOVA). In each treatment group the relationship between the covariate and the dependent variable is linear (the covariate and dependent variable are expressed at the first power only) [@rutherford2011[p. 240]].

Assumption 7
: **Homogeneity of the coefficients** (ANCOVA). The regression coefficients of the dependent variable on the covariate in each treatment group are homogeneous [@rutherford2011[p. 240]].

## Locking the Data Directory

```{r}
data_dir |> lockr::lock_dir(public_key = public_key_path)
```
