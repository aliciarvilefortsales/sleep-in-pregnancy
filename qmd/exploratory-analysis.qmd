# Exploratory Analysis

```{r}
#| label: setup
#| include: false

library(here)

source(here("R", "_setup.R"))
```

## Overview

This report provides an exploratory analysis of the data collected in the study: *Does Sleep Regularity Worsen Over the Third Trimester of Pregnancy?*.

## Set the Environment

### Load Packages

```{r}
#| output: false

library(actverse) # github.com/danielvartan/actverse
library(askpass)
library(checkmate)
library(cli)
library(dplyr)
library(fs)
library(ggplot2)
library(googlesheets4)
library(grDevices)
library(here)
library(hms)
library(lubridate)
library(lubritime) # github.com/danielvartan/lubritime
library(readr)
library(orbis) # github.com/danielvartan/orbis
library(plotr) # github.com/danielvartan/plotr
library(purrr)
library(rutils) # github.com/danielvartan/rutils
library(scaler) # github.com/danielvartan/scaler
library(scales)
library(sodium)
library(stats)
library(stringr)
library(tidyr)
```

### Load Custom Functions

```{r}
source(here("R", "anonymize_id.R"))
source(here("R", "ga.R"))
source(here("R", "summarize_his.R"))
```

### Set Data Directories

```{r}
data_dir <- here("data")
processed_data_dir <- here(data_dir, "processed")
actigraphy_processed_data_dir <- here(data_dir, "processed", "actigraphy")
sri_data_dir <- here(data_dir, "sri")
sleep_prop_dir <- here(data_dir, "sleep-prop")
lux_data_dir <- here(data_dir, "lux")
```

```{r}
for (i in ls(pattern = "_dir$")) {
  if (!dir_exists(get(i))) dir_create(get(i), recurse = TRUE)
}
```

### Set Keys

```{r}
#| output: false

gs4_auth(
  cache = here(".secrets"),
  email = TRUE,
  use_oob = FALSE
)
```

```{r}
#| output: false

salt <- Sys.getenv("PREGNANCY_SALT") # askpass()
```

### Set Initial Variables

```{r}
#| output: false

Sys.setlocale("LC_TIME", "pt_BR.UTF-8")

Sys.setenv(LC_TIME = "pt_BR.UTF-8")
Sys.setenv(LC_NUMERIC = "pt_BR.UTF-8")
Sys.setenv(LANG = "pt")
Sys.setenv(LANGUAGE = "pt")
```

## Download Actigraphy Processed Data from OSF

::: {.callout-note}
See the `osf-routines.qmd` Quarto notebook to download and decrypt the actigraphy processed data from OSF.
:::

## Download and Import the Control Form Data

```{r}
#| label: Download and Import the Control Form Data
#| output: false

control_form_data <-
  "13wtDr4fRD1wJSM-qdLOdGSchF8oXU1bG0Jtccu24GhY" |>
  read_sheet(
    sheet = "Dataset",
    col_types = "c",
    na = c("", "NA")
  )
```

## Download and Import the Field Form Data

```{r}
#| label: Download and Import the Field Form Data
#| output: false

field_form_data <-
  "1tY_TT0nPXFsErYQS2VED0-hqTzgHudA9BfhRhYG19fw" |>
  read_sheet(
    sheet = "Dataset",
    col_types = "c",
    na = c("", "NA")
  )
```

## Download and Import the Primary Sleep Data

```{r}
#| label: Download and Import the Primary Sleep Data

sheet_names <-
  "18wKHeqbNfrQDzjyOKIX5MCgjVK0WMho6xvdQQpA7ZLE" |>
  sheet_names() %>%
  magrittr::extract(
    !. %in% c(
      c(
        "Documentation",
        "Codebook",
        "Validation",
        "Template",
        "[TEMPLATE]"
      )
    )
  ) |>
  unique()

```

```{r}
#| code-fold: false

sheet_names
```

```{r}
#| output: false

primary_sleep_data <- tibble()

for (i in sheet_names) {
  i_data <-
    "18wKHeqbNfrQDzjyOKIX5MCgjVK0WMho6xvdQQpA7ZLE" |>
    read_sheet(
      sheet = i,
      col_types = "c",
      na = c("", "NA")
    ) |>
      drop_na(date)

  if (nrow(i_data) == 0) next

  i_data <-
    i_data |>
    mutate(id = i) |>
    relocate(id)

  primary_sleep_data <-
    primary_sleep_data |>
    bind_rows(i_data)
}
```

## Download and Import the Secondary Sleep Data

```{r}
#| label: Download and Import the Secondary Sleep Data

sheet_names <-
  "12xFtuHk3dBB6KqU8qhLS17ZcrZqs0AjGWaQtnUE82Uk" |>
  sheet_names() %>%
  magrittr::extract(
    !. %in% c(
      c(
        "Documentation",
        "Codebook",
        "Validation",
        "Template",
        "[TEMPLATE]"
      )
    )
  ) |>
  unique()
```

```{r}
#| code-fold: false

sheet_names
```

```{r}
#| output: false

secondary_sleep_data <- tibble()

for (i in sheet_names) {
  i_data <-
    "12xFtuHk3dBB6KqU8qhLS17ZcrZqs0AjGWaQtnUE82Uk" |>
    read_sheet(
      sheet = i,
      col_types = "c",
      na = c("", "NA")
    ) |>
      drop_na(date)

  if (nrow(i_data) == 0) next

  i_data <-
    i_data |>
    mutate(id = i) |>
    relocate(id)

  secondary_sleep_data <-
    secondary_sleep_data |>
    bind_rows(i_data)
}
```

## Download and Import the Medical Records Data

```{r}
#| label: Download and Import the Medical Records Data
#| output: false

medical_record_data <-
  "10yvvTOCjZsRKPO8A4yn0NCvWe4Jn_Kq-Zu_CV4miGJI" |>
  read_sheet(
    sheet = "Dataset",
    col_types = "c",
    na = c("", "NA")
  )
```

## Filter and Tidy the Control Form Data

```{r}
#| label: Filter and Tidy the Control Form Data

control_form_data <-
  control_form_data |>
  `names<-`(paste0("X", seq_along(control_form_data))) |>
  dplyr::select(X5, X6, X12, X39, X40) |>
  rename(
    cpf = X5,
    id = X6,
    birth_center_delivery = X12,
    ultrasound_ga = X39,
    ultrasound_date = X40
  ) |>
  mutate(
    birth_center_delivery = case_when(
      tolower(trimws(birth_center_delivery)) == "sim" ~ TRUE,
      tolower(trimws(birth_center_delivery)) == "não" ~ FALSE,
      TRUE ~ NA
    ),
    ultrasound_date = ymd(ultrasound_date),
    ga_start = if_else(
      is.na(ultrasound_ga),
      as.Date(NA),
      ga_start(
        ultrasound = ultrasound_date,
        ga =
          str_extract(ultrasound_ga, "^\\d{1,2}") |>
          as.integer() |>
          weeks() |>
          add(
            str_extract(ultrasound_ga, "\\d(?= di)") |>
            as.integer() |>
            days()
          )
      )
    )
  ) |>
  dplyr::select(-starts_with("cpf")) |>
  dplyr::select(
    id, birth_center_delivery, ga_start
  )
```

```{r}
#| code-fold: false

control_form_data |> glimpse()
```

## Filter and Tidy the Field Form Data

```{r}
#| label: Filter and Tidy the Field Form Data

field_form_data <-
  field_form_data |>
  `names<-`(paste0("X", seq_along(field_form_data))) |>
  dplyr::select(
    X1, X4, X5, X11, X91, X92, X95, X96, X97, X99, X101, X102, X106, X119,
    X118, X125, X126
  ) |>
  rename(
    timestamp = X1,
    birth_date = X4,
    cpf = X5,
    weight_before = X96,
    weight_current = X95,
    height = X97,
    ethnicity = X106,
    education = X118,
    family_income = X99,
    health_plan = X101,
    solo = X102,
    exercise = X119,
    work = X92,
    study = X91,
    gestations = X11,
    deliveries = X125,
    abortions = X126
  ) |>
  mutate(
    id = anonymize_id(cpf, salt),
    timestamp = mdy_hms(timestamp, tz = "America/Sao_Paulo"),
    birth_date = dmy(birth_date),
    age = scaler:::age(birth_date, timestamp),
    ethnicity = factor(
      ethnicity,
      levels = c(
        "Indígena",
        "Preta",
        "Parda",
        "Amarela",
        "Branca"
      ),
      ordered = TRUE
    ),
    education = factor(
      education,
      levels = c(
        "Não frequentou a escola",
        "Fundamental incompleto",
        "Fundamental completo",
        "Ensino médio incompleto",
        "Ensino médio completo",
        "Ensino superior incompleto",
        "Ensino superior completo",
        "Mestrado incompleto",
        "Mestrado completo",
        "Doutorado incompleto",
        "Doutorado completo",
        "Pós-doutorado incompleto",
        "Pós-doutorado completo"
      ),
      ordered = TRUE
    ),
    gestations = case_match(
      gestations,
      c("Sim", "0") ~ "1",
      "Não" ~ "0",
      .default = gestations
    ),
    deliveries = case_when(
      is.na(deliveries) ~ "0",
      TRUE ~ deliveries
    ),
    abortions = case_when(
      is.na(abortions) ~ "0",
      TRUE ~ abortions
    )
  ) |>
  mutate(
    across(
      .cols = all_of(
        c(
          "weight_before", "weight_current", "height",
          "family_income", "gestations", "deliveries",
          "abortions"
        )
      ),
      .fns = as.numeric
    )
  ) |>
  mutate(
    across(
      .cols = all_of(
        c("health_plan", "solo", "exercise", "work", "study")
      ),
      .fns = function(x) {
        case_match(
          x,
          "Sim" ~ TRUE,
          "Não" ~ FALSE
        )
      }
    )
  ) |>
  mutate(
    gestations = case_when(
      id == "ae5fc5cd" ~ 3,
      TRUE ~ gestations
    ),
  ) |>
  mutate(
    bmi_before = weight_before / ((height / 100)^2),
    bmi_current = weight_current / ((height / 100)^2)
  ) |>
  dplyr::select(-cpf) |>
  relocate(
    id, timestamp, birth_date, age, weight_before, weight_current, height, bmi_before, bmi_current, family_income
  )
```

```{r}
#| code-fold: false

field_form_data |> glimpse()
```

## Filter and Tidy the Primary Sleep Data

```{r}
#| label: Filter and Tidy the Primary Sleep Data

primary_sleep_data <-
  primary_sleep_data |>
  mutate(
    date = as.Date(date),
    crossover = as.logical(crossover),
    across(
      .cols = all_of(c("his", "hfs", "fps", "tts", "waso")),
      .fns = hms::parse_hms
    ),
    awakenings = as.numeric(awakenings),
    tts_fps = as.numeric(tts) / as.numeric(fps)
  ) |>
  relocate(tts_fps, .after = waso)
```

```{r}
#| code-fold: false

primary_sleep_data |> glimpse()
```

## Filter and Tidy the Secondary Sleep Data

```{r}
#| label: Filter and Tidy the Secondary Sleep Data

secondary_sleep_data <-
  secondary_sleep_data |>
  mutate(
    date = as.Date(date),
    crossover = as.logical(crossover),
    across(
      .cols = all_of(c("his", "hfs", "fps", "tts", "waso")),
      .fns = hms::parse_hms
    ),
    awakenings = as.numeric(awakenings),
    tts_fps = as.numeric(tts) / as.numeric(fps)
  ) |>
  relocate(tts_fps, .after = waso)
```

```{r}
#| code-fold: false

secondary_sleep_data |> glimpse()
```

## Filter and Tidy the Medical Record Data

```{r}
#| label: Filter and Tidy the Medical Record Data

medical_record_data <-
  medical_record_data |>
  mutate(
    across(
      .cols = all_of(c("partograph_begin", "baby_birth")),
      .fns = ~ ymd_hms(.x, tz = "America/Sao_Paulo")
    ),
    across(
      .cols = -all_of(c("id", "partograph_begin", "baby_birth")),
      .fns = as.numeric
    ),
    across(
      .cols = matches("^begin_dilation$|^apgar_"),
      .fns = as.integer
    )
  ) |>
  mutate(
    partograph_duration =
      interval(
        start = partograph_begin,
        end = baby_birth
      ) |>
        int_duration()
  )
```

```{r}
#| code-fold: false

medical_record_data |> glimpse()
```

## Import, Tidy and Transform the Processed Actigraphy Data

### Get Paths to Processed Actigraphy Data Files

```{r}
#| label: Import, Tidy and Transform the Processed Actigraphy Data

files <-
  dir_ls(
    path = actigraphy_processed_data_dir,
    type = "file",
    regexp = ".txt$"
  )
```

### Import, Tidy, Transform, and Write Data Files

```{r}
#| eval: false

cli_progress_bar(total = length(files), clear = FALSE)

for (i in files) {
  i_id <- str_remove(basename(i), "_actigraphy-processed-data.txt")

  i_ga_start <-
    control_form_data |>
    filter(id == i_id) |>
    pull(ga_start)

  i_data <-
    i |>
    read_acttrust(tz = "America/Sao_Paulo") |>
    mutate(
      ga =
        i_ga_start |>
        ga_point(timestamp) |>
        as.numeric() |>
        as.duration() |>
        add(
          as_hms(timestamp) |>
            as.numeric() |>
            as.duration()
        ),
      ga_week =
        ga |>
        as.numeric() |>
        divide_by(
          ddays(7) |>
            as.numeric()
        ) |>
        as.integer()
    ) |>
    suppressMessages() |>
    suppressWarnings()

  i_data |>
    write_rds(
      path(
        actigraphy_processed_data_dir,
        paste0(i_id, "_actigraphy-processed-data.rds")
      )
    )

  cli_progress_update()
}

cli_progress_done()
```

## Import and Group the Validated Actigraphy Data

### Get Paths to the Data Files

```{r}
#| label: Import and Group the Validated Actigraphy Data
#| eval: false

files <-
  dir_ls(
    path = actigraphy_processed_data_dir,
    type = "file",
    regexp = "_actigraphy-processed-data.rds$"
  )
```

### Import and Group the Data

```{r}
#| eval: false

actigraphy_data <-
  files |>
  map_dfr(read_rds)
```

```{r}
#| eval: false
#| include: false

actigraphy_data |> glimpse()
```

## Group Primary Sleep Data

```{r}
primary_sleep_data_stats <-
  primary_sleep_data |>
  summarize(
    n = n(),
    his_mean = summarize_his(his, mean, na.rm = TRUE),
    his_sd = summarize_his(his, sd, na.rm = TRUE),
    his_min = summarize_his(his, min, na.rm = TRUE),
    his_max = summarize_his(his, max, na.rm = TRUE),
    hfs_mean = summarize_hfs(hfs, mean, na.rm = TRUE),
    hfs_sd = summarize_hfs(hfs, sd, na.rm = TRUE),
    hfs_min = summarize_hfs(hfs, min, na.rm = TRUE),
    hfs_max = summarize_hfs(hfs, max, na.rm = TRUE),
    across(
      .cols = c(fps, tts, waso),
      .fns = list(
        mean = \(x) x |> mean(na.rm = TRUE) |> as_hms(),
        sd = \(x) x |> sd(na.rm = TRUE) |> as_hms(),
        min = \(x) x |> min(na.rm = TRUE) |> as_hms(),
        max = \(x) x |> max(na.rm = TRUE) |> as_hms()
      ),
      .names = "{.col}_{.fn}"
    ),
    across(
      .cols = c(tts_fps, awakenings),
      .fns = list(
        mean = \(x) x |> mean(na.rm = TRUE),
        sd = \(x) x |> sd(na.rm = TRUE),
        min = \(x) x |> min(na.rm = TRUE),
        max = \(x) x |> max(na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    ),
    .by = id
  )
```

```{r}
#| code-fold: false

primary_sleep_data_stats |> glimpse()
```

## Group Secondary Sleep Data

```{r}
secondary_sleep_data_stats <-
  secondary_sleep_data |>
  summarize(
    n = n(),
    his_mean = summarize_his(his, mean, na.rm = TRUE),
    his_sd = summarize_his(his, sd, na.rm = TRUE),
    his_min = summarize_his(his, min, na.rm = TRUE),
    his_max = summarize_his(his, max, na.rm = TRUE),
    hfs_mean = summarize_hfs(hfs, mean, na.rm = TRUE),
    hfs_sd = summarize_hfs(hfs, sd, na.rm = TRUE),
    hfs_min = summarize_hfs(hfs, min, na.rm = TRUE),
    hfs_max = summarize_hfs(hfs, max, na.rm = TRUE),
    across(
      .cols = c(fps, tts, waso),
      .fns = list(
        mean = \(x) x |> mean(na.rm = TRUE) |> as_hms(),
        sd = \(x) x |> sd(na.rm = TRUE) |> as_hms(),
        min = \(x) x |> min(na.rm = TRUE) |> as_hms(),
        max = \(x) x |> max(na.rm = TRUE) |> as_hms()
      ),
      .names = "{.col}_{.fn}"
    ),
    across(
      .cols = c(tts_fps, awakenings),
      .fns = list(
        mean = \(x) x |> mean(na.rm = TRUE),
        sd = \(x) x |> sd(na.rm = TRUE),
        min = \(x) x |> min(na.rm = TRUE),
        max = \(x) x |> max(na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    ),
    .by = id
  )
```

```{r}
#| code-fold: false

secondary_sleep_data_stats |> glimpse()
```

## Import, Group and Transform SRI Data

::: {.callout-note}
See the _SRI Analysis Report_ Quarto notebook report to process and write the Sleep Irregularity Index (SRI) data.
:::

### SRI by Gestational Age Week

#### Get Paths to the Data Files

```{r}
#| label: Import, Group and Transform SRI Data

files <-
  dir_ls(
    path = sri_data_dir,
    type = "file",
    regexp = "_sri-data.rds$"
  )
```

#### Import, Group and Transform the Data

```{r}
sri_data <- tibble()

cli_progress_bar(total = length(files), clear = FALSE)

for (i in files) {
  sri_data <-
    i |>
    read_rds() |>
    mutate(
      time =
        time |>
        as.numeric() |>
        divide_by(60) |>
        as.integer() |>
        dminutes() |>
        as.numeric() |>
        as_hms()
    ) |>
    bind_rows(sri_data)

  cli_progress_update()
}

cli_progress_done()
```

```{r}
sri_data <-
  sri_data |>
  mutate(ga_week = as.factor(ga_week)) |>
  arrange(ga_week)
```

```{r}
#| code-fold: false

sri_data |> glimpse()
```

### SRI Mean Data by Gestational Age Week and ID

#### Get Paths to Data Files

```{r}
files <-
  dir_ls(
    path = sri_data_dir,
    type = "file",
    regexp = "_sri-mean-data.rds$"
  )
```

#### Import and Group Data

```{r}
sri_mean_data <- tibble()

cli_progress_bar(total = length(files), clear = FALSE)

for (i in files) {
  sri_mean_data <-
    i |>
    read_rds(i) |>
    bind_rows(sri_mean_data)

  cli_progress_update()
}

cli_progress_done()
```

#### Transform SRI Mean Data

```{r}
sri_mean_data <-
  sri_mean_data |>
  mutate(ga_week = as.factor(ga_week)) |>
  arrange(ga_week)
```

```{r}
#| code-fold: false

sri_mean_data |> glimpse()
```

### SRI Mean Data by Gestational Age Week (Only)

```{r}
sri_mean_data_by_ga_week <-
  sri_data |>
  summarize(
    sri_mean = mean(sri, na.rm = TRUE),
    sri_sd = sd(sri, na.rm = TRUE),
    sri_min = min(sri, na.rm = TRUE),
    sri_max = max(sri, na.rm = TRUE),
    .by = ga_week
  )
```

## Get SRI Data Unique IDs

```{r}
#| labels: Get SRI Data Unique IDs

sri_data_ids <- sri_data |> pull(id) |> unique()
```

```{r}
#| code-fold: false

sri_data_ids
```

## Categorize Participantes by SRI Levels

```{r}
#| label: Categorize Participantes by SRI Levels

sri_data_by_id <-
  sri_data |>
  summarize(
    sri = mean(sri, na.rm = TRUE),
    .by = id
  )
```

```{r}
sri_quintiles <-
  sri_data_by_id |>
  pull(sri) |>
  quantile(probs = c(0, 0.2, 0.4, 0.6, 0.8, 1))
```

```{r}
#| code-fold: false

sri_quintiles
```

```{r}
sri_top_quintile <- sri_quintiles[5]
```

```{r}
sri_bottom_quintile <- sri_quintiles[2]
```

```{r}
regular_sri_ids <-
  sri_data_by_id |>
  filter(sri >= sri_top_quintile) |>
  pull(id)
```

```{r}
#| code-fold: false

regular_sri_ids
```

```{r}
others_sri_ids <-
  sri_data_by_id |>
  filter(
    sri > sri_bottom_quintile &
    sri < sri_top_quintile
  ) |>
  pull(id)
```

```{r}
#| code-fold: false

others_sri_ids
```

```{r}
irregular_sri_ids <-
  sri_data_by_id |>
  filter(sri <= sri_bottom_quintile) |>
  pull(id)
```

```{r}
#| code-fold: false

irregular_sri_ids
```

## Import, Group and Transform Sleep Proportions Data

::: {.callout-note}
See the _SRI Analysis Report_ Quarto notebook report to process and write the Sleep Proportions Index data.
:::

### Sleep Proportions by Gestational Age Week

#### Get Paths to Data Files

```{r}
#| label: Group and Transform Sleep Proportions Data

files <-
  dir_ls(
    path = sleep_prop_dir,
    type = "file",
    regexp = "_sleep-prop-data.rds$"
  )
```

#### Group and Transform Data

```{r}
sleep_prop_data <- tibble()

cli_progress_bar(total = length(files), clear = FALSE)

for (i in files) {
  sleep_prop_data <-
    i |>
    read_rds() |>
    mutate(
      time =
        time |>
        as.numeric() |>
        divide_by(60) |>
        as.integer() |>
        dminutes() |>
        as.numeric() |>
        as_hms()
    ) |>
    bind_rows(sleep_prop_data)

  cli_progress_update()
}

cli_progress_done()
```

```{r}
sleep_prop_data <-
  sleep_prop_data |>
  mutate(ga_week = as.factor(ga_week)) |>
  arrange(ga_week)
```

```{r}
#| code-fold: false

sleep_prop_data |> glimpse()
```

### Sleep Proportions Mean Data by Gestational Age Week and IDs

#### Get Paths to Mean Data Files

```{r}
#| label: Group and Transform Sleep Proportions Mean Data

files <-
  dir_ls(
    path = sleep_prop_dir,
    type = "file",
    regexp = "_sleep-prop-mean-data.rds$"
  )
```

#### Import and Group Mean Data

```{r}
sleep_prop_mean_data <- tibble()

cli_progress_bar(total = length(files), clear = FALSE)

for (i in files) {
  sleep_prop_mean_data <-
    i |>
    read_rds(i) |>
    bind_rows(sleep_prop_mean_data)

  cli_progress_update()
}

cli_progress_done()
```

#### Transform Mean Data

```{r}
sleep_prop_mean_data <-
  sleep_prop_mean_data |>
  mutate(ga_week = as.factor(ga_week)) |>
  arrange(ga_week)
```

```{r}
#| code-fold: false

sleep_prop_mean_data |> glimpse()
```

### Sleep Proportions Mean Data by Gestational Age Week (Only)

```{r}
sleep_prop_mean_data_by_ga_week <-
  sleep_prop_data |>
  summarize(
    sleep_prop_mean = mean(prop, na.rm = TRUE),
    sleep_prop_sd = sd(prop, na.rm = TRUE),
    sleep_prop_min = min(prop, na.rm = TRUE),
    sleep_prop_max = max(prop, na.rm = TRUE),
    .by = ga_week
  )
```

## Import, Group and Transform Illuminance Levels Data

::: {.callout-note}
See the _SRI Analysis Report_ Quarto notebook report to process and write the Illuminance Data data.
:::

### Illuminance Levels by Gestational Age Week

#### Get Paths to Data Files

```{r}
#| label: Group and Transform Illuminance Data

files <-
  dir_ls(
    path = lux_data_dir,
    type = "file",
    regexp = "_lux-data.rds$"
  )
```

#### Group and Transform Data

```{r}
lux_data <- tibble()

cli_progress_bar(total = length(files), clear = FALSE)

for (i in files) {
  lux_data <-
    i |>
    read_rds() |>
    mutate(
      time =
        time |>
        as.numeric() |>
        divide_by(60) |>
        as.integer() |>
        dminutes() |>
        as.numeric() |>
        as_hms()
    ) |>
    bind_rows(lux_data)

  cli_progress_update()
}

cli_progress_done()
```

```{r}
lux_data <-
  lux_data |>
  mutate(ga_week = as.factor(ga_week)) |>
  arrange(ga_week)
```

```{r}
#| code-fold: false

lux_data |> glimpse()
```


### Illuminance Levels Mean Data by Gestational Age Week and IDs

#### Get Paths to Data Files

```{r}
#| label: Group and Transform Illuminance Mean Data

files <-
  dir_ls(
    path = lux_data_dir,
    type = "file",
    regexp = "_lux-mean-data.rds$"
  )
```

#### Import and Group Mean Data

```{r}
lux_mean_data <- tibble()

cli_progress_bar(total = length(files), clear = FALSE)

for (i in files) {
  lux_mean_data <-
    i |>
    read_rds(i) |>
    bind_rows(lux_mean_data)

  cli_progress_update()
}

cli_progress_done()
```

#### Transform Mean Data

```{r}
lux_mean_data <-
  lux_mean_data |>
  mutate(ga_week = as.factor(ga_week)) |>
  arrange(ga_week)
```

```{r}
#| code-fold: false

lux_mean_data |> glimpse()
```

### Illuminance Levels Mean Data by Gestational Age Week (Only)

```{r}
lux_mean_data_by_ga_week <-
  lux_data |>
  summarize(
    lux_mean = mean(lux, na.rm = TRUE),
    lux_sd = sd(lux, na.rm = TRUE),
    lux_min = min(lux, na.rm = TRUE),
    lux_max = max(lux, na.rm = TRUE),
    .by = ga_week
  )
```

## Create Main Dataset

```{r}
#| label: Create Main Dataset

data <-
  field_form_data |>
  left_join(control_form_data, by = "id") |>
  left_join(medical_record_data, by = "id") |>
  left_join(
    primary_sleep_data_stats,
    by = "id",
    suffix = c("", "_primary")
  ) |>
  left_join(
    secondary_sleep_data_stats,
    by = "id",
    suffix = c("", "_secondary")
  ) |>
  filter(id %in% sri_data_ids) |>
  rename(n_primary_sleep = n, n_secondary_sleep = n_secondary) |>
  mutate(
    ga_duration =
      interval(
        start = ga_start,
        end = baby_birth
      ) |>
      int_length(),
    ga_duration = ifelse(sign(ga_duration) == -1, NA, ga_duration),
    ga_duration = as.duration(ga_duration)
  ) |>
  dplyr::select(-starts_with("cpf"))
```

```{r}
data |> glimpse()
```


## Get Frequency and Descriptive Statistics (General)

```{r}
#| label: Get Descriptive Statistics for Linear Temporal Variables

variables <-
  data |>
  select(!starts_with(c("his_", "hfs_"))) |>
  names()
```

```{r}
#| code-fold: false

for (i in variables) {
  cli_h1(i)
  cat_line()

  data |>
    stats_summary(
      col = i,
      name = i,
      threshold = NULL
    ) |>
    print(n = Inf)

  cat_line()
}
```

## Get Frequency and Descriptive Statistics (Circular Temporal Variables)

```{r}
#| label: Get Descriptive Statistics for Circular Temporal Variables

variables <-
  data |>
  select(starts_with(c("his_", "hfs_"))) |>
  names()
```

```{r}
#| code-fold: false

for (i in variables) {
  cli_h1(i)
  cat_line()

  if (str_detect(i, "^hfs_")) {
    threshold <- hms::parse_hms("18:00:00")
  } else {
    threshold <- hms::parse_hms("12:00:00")
  }

  data |>
    stats_summary(
      col = i,
      name = i,
      threshold = threshold
    ) |>
    print(n = Inf)

  cat_line()
}
```

## Group Data by Gestational Age Week

::: {.callout-note}
The sleep statistics (e.g., his, hfs) by gestational age week are not included.
:::

```{r}
#| label: Group Data by Gestational Age Week

ga_group_data <-
  sri_mean_data_by_ga_week |>
  left_join(sleep_prop_mean_data_by_ga_week, by = "ga_week") |>
  left_join(lux_mean_data_by_ga_week, by = "ga_week") |>
  arrange(ga_week)
```

```{r}
#| code-fold: false

ga_group_data |> glimpse()
```

```{r}
ga_group_data
```

## Group Data by SRI Group

```{r}
#| label: Group Data by SRI Group

sri_mean_data_by_sri_group <-
  sri_data |>
  filter(id %in% sri_data_ids) |>
  mutate(
    group = case_when(
      id %in% regular_sri_ids ~ "regular",
      id %in% others_sri_ids ~ "others",
      id %in% irregular_sri_ids ~ "irregular"
    )
  ) |>
  summarize(
    sri_mean = mean(sri, na.rm = TRUE),
    sri_sd = sd(sri, na.rm = TRUE),
    sri_min = min(sri, na.rm = TRUE),
    sri_max = max(sri, na.rm = TRUE),
    .by = group
  ) |>
  arrange(desc(group))
```

```{r}
sleep_prop_mean_data_by_sri_group <-
  sleep_prop_data |>
  filter(id %in% sri_data_ids) |>
  mutate(
    group = case_when(
      id %in% regular_sri_ids ~ "regular",
      id %in% others_sri_ids ~ "others",
      id %in% irregular_sri_ids ~ "irregular"
    )
  ) |>
  summarize(
    sleep_prop_mean = mean(prop, na.rm = TRUE),
    sleep_prop_sd = sd(prop, na.rm = TRUE),
    sleep_prop_min = min(prop, na.rm = TRUE),
    sleep_prop_max = max(prop, na.rm = TRUE),
    .by = group
  ) |>
  arrange(desc(group))
```

```{r}
lux_mean_data_by_sri_group <-
  lux_data |>
  filter(id %in% sri_data_ids) |>
  mutate(
    group = case_when(
      id %in% regular_sri_ids ~ "regular",
      id %in% others_sri_ids ~ "others",
      id %in% irregular_sri_ids ~ "irregular"
    )
  ) |>
  summarize(
    lux_mean = mean(lux, na.rm = TRUE),
    lux_sd = sd(lux, na.rm = TRUE),
    lux_min = min(lux, na.rm = TRUE),
    lux_max = max(lux, na.rm = TRUE),
    .by = group
  ) |>
  arrange(desc(group))
```

```{r}
primary_sleep_data_by_sri_group <-
  primary_sleep_data |>
  filter(id %in% sri_data_ids) |>
  mutate(
    group = case_when(
      id %in% regular_sri_ids ~ "regular",
      id %in% others_sri_ids ~ "others",
      id %in% irregular_sri_ids ~ "irregular"
    )
  ) |>
  summarize(
    his_mean = summarize_his(his, mean, na.rm = TRUE),
    his_sd = summarize_his(his, sd, na.rm = TRUE),
    his_min = summarize_his(his, min, na.rm = TRUE),
    his_max = summarize_his(his, max, na.rm = TRUE),
    hfs_mean = summarize_hfs(hfs, mean, na.rm = TRUE),
    hfs_sd = summarize_hfs(hfs, sd, na.rm = TRUE),
    hfs_min = summarize_hfs(hfs, min, na.rm = TRUE),
    hfs_max = summarize_hfs(hfs, max, na.rm = TRUE),
    across(
      .cols = c(fps, tts, waso),
      .fns = list(
        mean = \(x) x |> mean(na.rm = TRUE) |> as_hms(),
        sd = \(x) x |> sd(na.rm = TRUE) |> as_hms(),
        min = \(x) x |> min(na.rm = TRUE) |> as_hms(),
        max = \(x) x |> max(na.rm = TRUE) |> as_hms()
      ),
      .names = "{.col}_{.fn}"
    ),
    across(
      .cols = c(tts_fps, awakenings),
      .fns = list(
        mean = \(x) x |> mean(na.rm = TRUE),
        sd = \(x) x |> sd(na.rm = TRUE),
        min = \(x) x |> min(na.rm = TRUE),
        max = \(x) x |> max(na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    ),
    .by = group
  ) |>
  arrange(desc(group))
```

```{r}
sri_group_data <-
  sri_mean_data_by_sri_group |>
  left_join(sleep_prop_mean_data_by_sri_group, by = "group") |>
  left_join(lux_mean_data_by_sri_group, by = "group") |>
  left_join(primary_sleep_data_by_sri_group, by = "group") |>
  arrange(desc(group))
```

```{r}
#| code-fold: false

sri_group_data |> glimpse()
```

```{r}
sri_group_data
```

## Group Data by SRI Group and Gestational Age Week

```{r}
#| label: Group Data by SRI Group and Gestational Age Week

sri_mean_data_by_sri_group_ga_week <-
  sri_data |>
  filter(id %in% sri_data_ids) |>
  mutate(
    group = case_when(
      id %in% regular_sri_ids ~ "regular",
      id %in% others_sri_ids ~ "others",
      id %in% irregular_sri_ids ~ "irregular"
    )
  ) |>
  summarize(
    sri_mean = mean(sri, na.rm = TRUE),
    sri_sd = sd(sri, na.rm = TRUE),
    sri_min = min(sri, na.rm = TRUE),
    sri_max = max(sri, na.rm = TRUE),
    .by = c(group, ga_week)
  ) |>
  arrange(desc(group), ga_week)
```

```{r}
#| code-fold: false

sri_mean_data_by_sri_group_ga_week |> glimpse()
```

```{r}
sri_mean_data_by_sri_group_ga_week
```

```{r}
sleep_prop_data_by_sri_group_ga_week <-
  sleep_prop_data |>
  filter(id %in% sri_data_ids) |>
  mutate(
    group = case_when(
      id %in% regular_sri_ids ~ "regular",
      id %in% others_sri_ids ~ "others",
      id %in% irregular_sri_ids ~ "irregular"
    )
  ) |>
  summarize(
    sleep_prop_mean = mean(prop, na.rm = TRUE),
    sleep_prop_sd = sd(prop, na.rm = TRUE),
    sleep_prop_min = min(prop, na.rm = TRUE),
    sleep_prop_max = max(prop, na.rm = TRUE),
    .by = c(group, ga_week)
  ) |>
  arrange(desc(group), ga_week)
```

```{r}
#| code-fold: false

sleep_prop_data_by_sri_group_ga_week |> glimpse()
```

```{r}
sleep_prop_data_by_sri_group_ga_week
```

```{r}
lux_data_by_sri_group_ga_week <-
  lux_data |>
  filter(id %in% sri_data_ids) |>
  mutate(
    group = case_when(
      id %in% regular_sri_ids ~ "regular",
      id %in% others_sri_ids ~ "others",
      id %in% irregular_sri_ids ~ "irregular"
    )
  ) |>
  summarize(
    lux_mean = mean(lux, na.rm = TRUE),
    lux_sd = sd(lux, na.rm = TRUE),
    lux_min = min(lux, na.rm = TRUE),
    lux_max = max(lux, na.rm = TRUE),
    .by = c(group, ga_week)
  ) |>
  arrange(desc(group), ga_week)
```

```{r}
#| code-fold: false

lux_data_by_sri_group_ga_week |> glimpse()
```

```{r}
lux_data_by_sri_group_ga_week
```

## Plot Distributions

### `fps_mean`

```{r}
#| label: Plot Distributions

data |>
  plotr:::plot_dist(
    col = "fps_mean",
    line_color = "red"
  )
```

```{r}
data |>
  plotr:::plot_box_plot(
    col = "fps_mean",
    line_color = "red"
  )
```

### `bmi_current`

```{r}
data |>
  plotr:::plot_dist(
    col = "bmi_current",
    line_color = "red"
  )
```

```{r}
data |>
  plotr:::plot_box_plot(
    col = "bmi_current",
    line_color = "red"
  )
```

## Plot Correlation Matrices

```{r}
#| label: Plot Correlation Matrices
#| fig-width: 10
#| fig-height: 7.5

data |>
  plotr:::plot_ggally(
    cols = c(
      "partograph_duration", "age", "family_income", "bmi_before"
    ),
    labels = c(
      "Duração do partograma", "Idade", "Renda familiar", "IMC"
    )
  )
```

```{r}
#| fig-width: 10
#| fig-height: 7.5

data |>
  plotr:::plot_ggally(
    cols = c(
      "partograph_duration", "gestations", "deliveries", "abortions"
    ),
    labels = c(
      "Duração do partograma", "# Gestações", "# Partos", "# Abortos"
    )
  )
```

```{r}
#| fig-width: 10
#| fig-height: 7.5

data |>
  plotr:::plot_ggally(
    cols = c(
      "partograph_duration", "baby_weight", "baby_length",
      "baby_head_perimeter",  "baby_thoracic_perimeter",
      "baby_abdominal_perimeter"
    ),
    labels = c(
      "Duração do partograma", "Peso do bebê", "Comprimento do bebê",
      "Per. da cabeça do bebê", "Per. torácico do bebê",
      "Per. abdominal do bebê"
    )
  )
```

```{r}
#| fig-width: 10
#| fig-height: 7.5

data |>
  plotr:::plot_ggally(
    cols = c("partograph_duration", "fps_mean", "waso_mean", "awakenings_mean"),
    labels = c("Duração do partograma", "FPS", "WASO", "Desp.")
  )
```

```{r}
#| fig-width: 10
#| fig-height: 7.5

data |>
  mutate(
    his_mean = his_mean |> link_to_timeline(),
    hfs_mean = hfs_mean |> link_to_timeline()
  ) |>
  plotr:::plot_ggally(
    cols = c(
      "his_mean", "hfs_mean", "fps_mean", "tts_mean", "tts_fps_mean",
       "waso_mean", "awakenings_mean"
    ),
    labels = c(
      "HIS", "HFS", "FPS", "TTS", "TTS/FPS", "WASO", "Desp."
    ),
    brandr = FALSE
  )
```

```{r}
#| fig-width: 10
#| fig-height: 7.5

data |>
  plotr:::plot_ggally(
    cols = c(
      "fps_mean", "tts_mean", "waso_mean", "awakenings_mean",
      "age", "family_income", "bmi_before"
    ),
    labels = c(
      "FPS", "TTS", "WASO", "Desp.", "Idade", "Renda", "IMC"
    )
  )
```

```{r}
#| eval: false
#| include: false

dev.off()
```

## Actograms

### `f1e30a89`

```{r}
actigraphy_data <-
  actigraphy_processed_data_dir |>
  dir_ls(type = "file") |>
  str_subset("f1e30a89.+\\.rds") |>
  read_rds()
```

```{r}
#| fig-width: 10
#| fig-height: 10

actigraphy_data |>
  actogram(
    days = -1,
    latitude = brazil_state_latitude("sp"),
    longitude = brazil_state_longitude("sp"),
    locale = "pt_BR.UTF-8",
    x_label = "2 Dias — Horas",
    y_label = "Dias",
    date_format = "%a %d/%m",
    labels = c(
      "1" = "Sono",
      "2" = "Despertar",
      "4" = "Offwrist",
      "base" = "Atividade (PIM)",
      "lp" = "Fase Clara",
      "dp" = "Fase Escura"
    ),
    colors = c(
      "1" = "#0000FF", # "#410085"
      "2" = "#FFFF00", # "#FFB426"
      "4" = "#FF0000", # "#FC2913"
      "base" = "#000000", # "#000040"
      "lp" = "#FFFFFF",
      "dp" = "#D7D7D7"
    )
  )
```
