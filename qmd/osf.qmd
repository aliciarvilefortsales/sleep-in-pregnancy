---
execute:
  eval: false
---

# Download and Upload Files from and to OSF

```{r}
#| label: setup
#| include: false

library(here)

source(here("R", "_setup.R"))
```

## Overview

This notebook aim to help download or upload files to OSF.

## Set the Environment

### Load Packages

```{r}
library(askpass)
library(cli)
library(clipr)
library(dplyr)
library(fs)
library(here)
library(lubritime)
library(magrittr)
library(osfr)
library(readr)
library(stringr)
library(utils)
```

### Set Data Directories

```{r}
data_dir <- here("data")
```

```{r}
if (!dir_exists(data_dir)) {
  dir_create(data_dir, recurse = TRUE)
}
```

### Set Keys

```{r}
#| eval: false
#| output: false

osf_auth(Sys.getenv("OSF_PAT")) # askpass()
```

```{r}
#| eval: false
#| output: false

gs4_auth(cache = ".secrets")
```

```{r}
private_key <- here::here("_ssh", "id_rsa")
```

```{r}
public_key <- here::here("_ssh", "id_rsa.pub")
```

```{r}
#| eval: false
#| output: false

password <- Sys.getenv("PREGNANCY_PASSWORD") # askpass()
```

```{r}
#| eval: false
#| output: false

salt <- Sys.getenv("PREGNANCY_SALT") # askpass()
```

### Set OSF IDs

```{r}
osf_pilot_data_id <- "tj5u2"
osf_raw_data_id <- "7kg34"
osf_processed_data_id <- "a2dsw"
osf_bundles_id <- "fvh4u"
osf_tidy_data_id <- "npkjw"
osf_feedbacks_id <- "8hs7v"
```

```{r}
for (i in ls(pattern = "^osf_.*_id$")) {
  assign(
    x = i,
    value = paste0("https://osf.io/", get(i)),
    envir = .GlobalEnv
  )
}
```

## Download Metadata for Pilot Data Files

## Download Metadata for Raw Actigraphy Files

## Download Metadata for Processed Actigraphy Files

### Set Data Subdirectory

```{r}
data_dir <- here("data", "processed", "actigraphy")
```

```{r}
if (!dir_exists(data_dir)) {
  dir_create(data_dir, recurse = TRUE)
}
```

### Retrieve Files Metadata

```{r}
osf_files <-
  osf_processed_data_id |>
  osf_retrieve_node() |>
  osf_ls_files(n_max = Inf) |>
  filter(name == "actigraphy") |>
  pull(id) |>
  osf_retrieve_file() |>
  osf_ls_files(n_max = Inf) |>
  filter(str_detect(name, "actigraphy-processed-data"))

osf_files
```

## Download Metadata for Bundle Files

## Download Metadata for Tidy Actigraphy Files

## Download Metadata for Feedback Files

## Download Files

```{r}
#| eval: false

files <-
  osf_files |>
  osf_download(
    path = data_dir,
    conflicts = "overwrite",
    progress = TRUE
  ) |>
  extract2("local_path") |>
  here()
```

## Unlock Files

```{r}
#| eval: false

unlocked_files <- character()

for (i in files) {
  # if (!file_exists(i)) next

  i_path <-
    i |>
    unlock_file(
      private_key = private_key,
      suffix = ".lockr",
      remove_file = TRUE,
      password = password
    )

  cat_line()

  unlocked_files <- c(unlocked_files, i_path)
}
```

## Upload Files

```{r}
#| eval: false

osf_id <- osf_bundles_id
```

```{r}
#| eval: false

# Create the README.md file

readme_file <- tempdir() |> file.path("README.md")

c(
  "# {pregnancy}",
  "",
  "* All files were locked with the project's public key. Ask the project administrators for the key if you need access.",
  "",
  paste0("* Last update: ", lubritime::round_time(Sys.time()), ".")
) |>
  readr::write_lines(readme_file)

readr::read_lines(readme_file)
```

```{r}
#| eval: false

osf_id |>
  osf_retrieve_node() |>
  osf_upload(
    path = readme_file,
    conflicts = "overwrite",
    progress = TRUE
  )
```

```{r}
#| eval: false

path <- NULL # Use `NULL` to refer to the root.
```

```{r}
#| eval: false

osf_data <-
  osf_id |>
  osf_retrieve_node() |>
  osf_ls_files(
    path = path,
    n_max = Inf
  ) |>
  dplyr::arrange(name)

osf_data
```

```{r}
#| eval: false

dir_path <- read_clip() |> normalizePath("/", mustWork = FALSE)
```

```{r}
#| eval: false

files <-
  list.files(dir_path) |>
  paste0(".lockr") |>
  setdiff(osf_data$name) |>
  stringr::str_subset("^README", negate = TRUE) |>
  stringr::str_remove("\\.lockr$")

# files <- list.files(dir_path)

files
```

```{r}
#| eval: false

file.path(dir_path, files)|>
  vapply( prettycheck:::test_file_exists, logical(1)) |>
  unname()
```

```{r}
#| eval: false

files |> write_clip()
```

```{r}
new_files <- character()

for (i in seq_along(files)) {
  i_from <- file.path(dir_path, files[i])
  i_to <- file.path(tempdir(), files[i])

  test <- file.copy(from = i_from, to = i_to, overwrite = TRUE)

  if (isTRUE(test)) new_files <- c(new_files, i_to)
}

locked_files <- character()

for (i in new_files) {
  i_path <- lock_file(
    i,
    public_key = public_key,
    remove_file = TRUE
  )

  cat_line()

  locked_files <- c(locked_files, i_path)
}
```

```{r}
#| eval: false

osf_id |>
  osf_retrieve_node() |>
  osf_upload(
    path = locked_files,
    conflicts = "overwrite",
    progress = TRUE
  )
```

## Lock Files

```{r}
#| eval: false

for (i in unlocked_files) {
  # if (!file_exists(i)) next

  i |>
    lock_file(
      public_key = public_key,
      suffix = ".lockr",
      remove_file = TRUE
  )

  cat_line()
}
```
